#!/usr/bin/env bash
set -euo pipefail

# cat-sources — safely read source files from PAPERS_DIR
#
# Usage:
#   cat-sources [paths...]
#   cat-sources                 # read newline-delimited paths from stdin
#
# Notes:
# - Only reads files under PAPERS_DIR (default: $HOME/papers).
# - Rejects absolute or parent-directory paths.
# - Treats inputs literally; no glob expansion.

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}

print_core_help() {
  cat <<'EOF'
cat-sources — print Markdown fulltext for paths under PAPERS_DIR

Usage:
  cat-sources [paths...]
  cat-sources               # read newline-delimited paths from stdin

Behavior:
  - Rejects absolute or parent-directory paths
  - Exits 1 if nothing was printed; exits 2 on invalid input
EOF
}

print_human_help() {
  print_core_help
  cat <<EOF

Environment:
  - PAPERS_DIR (default: ${PAPERS_DIR})

Workflow tips:
  - Pair with fd-sources or rg-sources to discover relative paths.
  - Use comments (# ...) in stdin lists to temporarily disable entries.

Notes:
  - Only streams files that live under PAPERS_DIR.
  - Preserves relative paths, so run from repo root to share lists.
EOF
}

human_requested=false
help_requested=false
for arg in "$@"; do
  case "$arg" in
    --human) human_requested=true ;;
    -h|--help) help_requested=true ;;
  esac
done

if $human_requested; then
  for arg in "$@"; do
    case "$arg" in
      --human|-h|--help) ;;
      *)
        echo "cat-sources: --human cannot be combined with $arg" >&2
        exit 2
        ;;
    esac
  done
  print_human_help
  exit 0
fi

if $help_requested; then
  print_core_help
  exit 0
fi

declare -a PATHS
PATHS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --)
      shift
      while [[ $# -gt 0 ]]; do
        PATHS+=("$1")
        shift
      done
      ;;
    -*)
      echo "cat-sources: unknown option: $1" >&2
      exit 2
      ;;
    *)
      PATHS+=("$1")
      shift
      ;;
  esac
done

if [[ ! -d "$PAPERS_DIR" ]]; then
  echo "cat-sources: PAPERS_DIR not found: $PAPERS_DIR" >&2
  exit 2
fi

read_stdin=false
if [[ ${#PATHS[@]} -eq 0 ]]; then
  read_stdin=true
fi

if $read_stdin; then
  while IFS= read -r line; do
    # skip blanks and comments
    [[ -z "$line" ]] && continue
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    PATHS+=("$line")
  done
fi

# validate paths for safety
safe_paths=()
for p in "${PATHS[@]}"; do
  # absolute path
  if [[ "$p" == /* ]]; then
    echo "cat-sources: absolute paths not allowed: $p" >&2
    exit 2
  fi
  # parent-directory traversal
  if [[ "$p" == ../* || "$p" == */../* || "$p" == */.. || "$p" == ./../* || "$p" == ".." ]]; then
    echo "cat-sources: parent-directory paths not allowed: $p" >&2
    exit 2
  fi
  safe_paths+=("$p")
done

cd "$PAPERS_DIR"

printed_any=false
missing_count=0

for rel in "${safe_paths[@]}"; do
  if [[ ! -f "$rel" ]]; then
    echo "cat-sources: not found: $rel" >&2
    missing_count=$((missing_count+1))
    continue
  fi
  cat -- "$rel"
  printed_any=true
done

if ! $printed_any; then
  exit 1
fi
exit 0
