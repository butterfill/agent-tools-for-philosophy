#!/usr/bin/env bash
set -euo pipefail

# draft2keys — Extract cited keys from drafts and optionally stream fulltext

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

print_help() {
  cat <<'EOF'
draft2keys — extract BibTeX keys from a draft and optionally print fulltext

Usage:
  draft2keys [--cat] <draft-file>

Citation forms parsed:
  - LaTeX: \cite...{key1,key2} with optional * and up to two [..] args
  - Pandoc: @key and [@key]

Output:
  - default: unique keys (in first-occurrence order), one per line
  - --cat: resolve each key via cite2md and stream concatenated Markdown

Exit codes:
  0: success (printed at least one key or any content in --cat)
  1: no citations found (or none resolved in --cat)
  2: usage/config error (e.g., missing draft, missing dependencies)

Dependencies:
  - rg (ripgrep), sed/awk
  - --cat requires cite2md (uses PAPERS_DIR)
EOF
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  print_help
  exit 0
fi

if ! command -v rg >/dev/null 2>&1; then
  echo "draft2keys: missing dependency: rg" >&2
  exit 2
fi

MODE="keys"
while [[ $# -gt 0 ]]; do
  case "$1" in
    --cat)
      MODE="cat"; shift ;;
    -*)
      echo "draft2keys: unknown option: $1" >&2; exit 2 ;;
    *)
      break ;;
  esac
done

if [[ $# -lt 1 ]]; then
  echo "draft2keys: missing draft file" >&2
  exit 2
fi

DRAFT="$1"
if [[ ! -f "$DRAFT" ]]; then
  echo "draft2keys: not found: $DRAFT" >&2
  exit 2
fi

# Extract LaTeX \cite forms and Pandoc @key tokens.
# Use ripgrep with multiline enabled to handle citations spanning lines.

latex_keys=$(rg -U -o --no-line-number '\\cite[A-Za-z]*\*?\s*(?:\[[^\]]*\]\s*){0,2}\{([^{}]+)\}' --replace '$1' -- "$DRAFT" | \
  awk -F',' '{ for (i=1;i<=NF;i++) { gsub(/^\s+|\s+$/, "", $i); if ($i!="") print $i } }' || true)

pandoc_keys=$(rg -U -o --no-line-number '\[@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)
pandoc_keys_inline=$(rg -U -o --no-line-number '@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)

# Merge and de-duplicate preserving first occurrence order.
all_keys=$(printf '%s\n%s\n%s\n' "$latex_keys" "$pandoc_keys" "$pandoc_keys_inline" | awk 'NF{ if (!seen[$0]++) print }')

if [[ -z "${all_keys//\n/}" ]]; then
  # No citations found
  exit 1
fi

case "$MODE" in
  keys)
    printf '%s\n' "$all_keys"
    ;;
  cat)
    cs_bin=$(command -v cite2md 2>/dev/null || true)
    if [[ -z "${cs_bin:-}" && -x "$SCRIPT_DIR/cite2md" ]]; then
      cs_bin="$SCRIPT_DIR/cite2md"
    fi
    if [[ -z "${cs_bin:-}" ]]; then
      echo "draft2keys: cite2md not found on PATH or alongside script" >&2
      exit 2
    fi
    # Stream keys via cite2md one by one; rely on cite2md for missing handling/logging
    any=false
    while IFS= read -r k; do
      [[ -z "$k" ]] && continue
      if out=$(PAPERS_DIR="$PAPERS_DIR" "$cs_bin" --cat "$k" 2>/dev/null); then
        printf '%s' "$out"
        any=true
      fi
    done <<< "$all_keys"
    if ! $any; then
      exit 1
    fi
    ;;
esac

exit 0
