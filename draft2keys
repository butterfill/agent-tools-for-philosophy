#!/usr/bin/env bash
set -euo pipefail

# draft2keys — Extract cited keys from drafts and optionally stream fulltext

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

print_help() {
  cat <<'EOF'
draft2keys — extract BibTeX keys from a draft

Usage:
  draft2keys <draft-file>

Citation forms parsed:
  - LaTeX: \cite...{key1,key2} with optional * and up to two [..] args
  - Pandoc: @key and [@key]

Output:
  - unique keys (in first-occurrence order), one per line

Exit codes:
  0: success (printed at least one key)
  1: no citations found
  2: usage/config error (e.g., missing draft)

Dependencies:
  - rg (ripgrep), sed/awk
EOF
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  print_help
  exit 0
fi

if ! command -v rg >/dev/null 2>&1; then
  echo "draft2keys: missing dependency: rg" >&2
  exit 2
fi

if [[ ${1:-} == --* ]]; then
  echo "draft2keys: unknown option: $1" >&2
  exit 2
fi

if [[ $# -lt 1 ]]; then
  echo "draft2keys: missing draft file" >&2
  exit 2
fi

DRAFT="$1"
if [[ ! -f "$DRAFT" ]]; then
  echo "draft2keys: not found: $DRAFT" >&2
  exit 2
fi

# Extract LaTeX \cite forms and Pandoc @key tokens.
# Use ripgrep with multiline enabled to handle citations spanning lines.

latex_keys=$(rg -U -o --no-line-number '\\cite[A-Za-z]*\*?\s*(?:\[[^\]]*\]\s*){0,2}\{([^{}]+)\}' --replace '$1' -- "$DRAFT" | \
  awk -F',' '{ for (i=1;i<=NF;i++) { gsub(/^\s+|\s+$/, "", $i); if ($i!="") print $i } }' || true)

pandoc_keys=$(rg -U -o --no-line-number '\[@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)
pandoc_keys_inline=$(rg -U -o --no-line-number '@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)

# Merge and de-duplicate preserving first occurrence order.
all_keys=$(printf '%s\n%s\n%s\n' "$latex_keys" "$pandoc_keys" "$pandoc_keys_inline" | awk 'NF{ if (!seen[$0]++) print }')

if [[ -z "${all_keys//\n/}" ]]; then
  # No citations found
  exit 1
fi

printf '%s\n' "$all_keys"
exit 0
