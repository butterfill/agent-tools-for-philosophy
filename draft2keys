#!/usr/bin/env bash
set -euo pipefail

# draft2keys — Extract cited keys from drafts and optionally stream fulltext

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

print_core_help() {
  cat <<'EOF'
draft2keys — extract BibTeX keys from a draft

Usage:
  draft2keys <draft-file>

Behavior:
  - Prints unique keys in first-occurrence order
  - Exit codes: 0 success, 1 no citations, 2 usage error
EOF
}

print_human_help() {
  print_core_help
  cat <<EOF

Parsers:
  - LaTeX \\cite...{key1,key2} (handles *, up to two optional [..] args)
  - Pandoc inline citations (@key, [@key])

Environment:
  - PAPERS_DIR (default: ${PAPERS_DIR}) — used by downstream tools like cite2md

Dependencies:
  - rg, sed, awk

Workflow tips:
  - draft2keys draft.md > keys.txt then feed keys into cite2md or cite2pdf.
  - Combine with cat-sources or rg-sources once you have the Markdown paths.
EOF
}

human_requested=false
help_requested=false
for arg in "$@"; do
  case "$arg" in
    --human) human_requested=true ;;
    -h|--help) help_requested=true ;;
  esac
done

if $human_requested; then
  for arg in "$@"; do
    case "$arg" in
      --human|-h|--help) ;;
      *)
        echo "draft2keys: --human cannot be combined with $arg" >&2
        exit 2
        ;;
    esac
  done
  print_human_help
  exit 0
fi

if $help_requested; then
  print_core_help
  exit 0
fi

if ! command -v rg >/dev/null 2>&1; then
  echo "draft2keys: missing dependency: rg" >&2
  exit 2
fi

if [[ ${1:-} == --* ]]; then
  echo "draft2keys: unknown option: $1" >&2
  exit 2
fi

if [[ $# -lt 1 ]]; then
  print_core_help >&2
  exit 2
fi

DRAFT="$1"
if [[ ! -f "$DRAFT" ]]; then
  echo "draft2keys: not found: $DRAFT" >&2
  exit 2
fi

# Extract LaTeX \cite forms and Pandoc @key tokens.
# Use ripgrep with multiline enabled to handle citations spanning lines.

latex_keys=$(rg -U -o --no-line-number '\\cite[A-Za-z]*\*?\s*(?:\[[^\]]*\]\s*){0,2}\{([^{}]+)\}' --replace '$1' -- "$DRAFT" | \
  awk -F',' '{ for (i=1;i<=NF;i++) { gsub(/^\s+|\s+$/, "", $i); if ($i!="") print $i } }' || true)

pandoc_keys=$(rg -U -o --no-line-number '\[@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)
pandoc_keys_inline=$(rg -U -o --no-line-number '@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)

# Merge and de-duplicate preserving first occurrence order.
all_keys=$(printf '%s\n%s\n%s\n' "$latex_keys" "$pandoc_keys" "$pandoc_keys_inline" | awk 'NF{ if (!seen[$0]++) print }')

if [[ -z "${all_keys//\n/}" ]]; then
  # No citations found
  exit 1
fi

printf '%s\n' "$all_keys"
exit 0
