#!/usr/bin/env bash
set -euo pipefail

# draft2keys â€” Extract cited keys from drafts and optionally stream fulltext

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
HELP_TEXT_DIR="$SCRIPT_DIR/help-text"

print_core_help() {
  cat "$HELP_TEXT_DIR/draft2keys-help.txt"
}

print_human_help() {
  cat "$HELP_TEXT_DIR/draft2keys-human.txt"
}

human_requested=false
help_requested=false
for arg in "$@"; do
  case "$arg" in
    --human) human_requested=true ;;
    -h|--help) help_requested=true ;;
  esac
done

if $human_requested; then
  for arg in "$@"; do
    case "$arg" in
      --human|-h|--help) ;;
      *)
        echo "draft2keys: --human cannot be combined with $arg" >&2
        exit 2
        ;;
    esac
  done
  print_human_help
  exit 0
fi

if $help_requested; then
  print_core_help
  exit 0
fi

if ! command -v rg >/dev/null 2>&1; then
  echo "draft2keys: missing dependency: rg" >&2
  exit 2
fi

if [[ ${1:-} == --* ]]; then
  echo "draft2keys: unknown option: $1" >&2
  exit 2
fi

if [[ $# -lt 1 ]]; then
  print_core_help >&2
  exit 2
fi

DRAFT="$1"
if [[ ! -f "$DRAFT" ]]; then
  echo "draft2keys: not found: $DRAFT" >&2
  exit 2
fi

# Extract LaTeX \cite forms and Pandoc @key tokens.
# Use ripgrep with multiline enabled to handle citations spanning lines.

# LaTeX: capture comma-separated keys inside single-line braces; disallow newlines/comments inside the brace group
latex_keys=$(rg -U -o --no-line-number '\\cite[A-Za-z]*\*?\s*(?:\[[^\]]*\]\s*){0,2}\{([^{}\n%]+)\}' --replace '$1' -- "$DRAFT" | \
  awk -F',' '{ for (i=1;i<=NF;i++) { gsub(/^\s+|\s+$/, "", $i); if ($i!="") print $i } }' || true)

# Pandoc: match @key tokens but avoid emails by requiring a non-email-local preceding char or start of line.
# This also captures @keys inside [@a; @b] blocks.
pandoc_keys=$(rg -U -o --no-line-number '(?:^|[^A-Za-z0-9._%+-])@([A-Za-z0-9:_-]+)' --replace '$1' -- "$DRAFT" || true)

# Merge and de-duplicate preserving first occurrence order.
all_keys=$(printf '%s\n%s\n' "$latex_keys" "$pandoc_keys" | awk 'NF{ if (!seen[$0]++) print }')

if [[ -z "${all_keys//\n/}" ]]; then
  # No citations found
  exit 1
fi

printf '%s\n' "$all_keys"
exit 0
