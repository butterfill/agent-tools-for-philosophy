#!/usr/bin/env bash
set -euo pipefail

# Resolve a LaTeX citation or BibTeX key to a Markdown fulltext file in ~/papers
# See --help for detailed usage.

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
INDEX_FILE="$PAPERS_DIR/bibtex-index.jsonl"

print_core_help() {
  cat <<'EOF'
cite2md â€” resolve citation/key(s) to Markdown fulltext path(s)

Usage:
  cite2md [--cat] [citation-or-key ...]
  cite2md [--cat]               # read newline-delimited keys from stdin

Flags:
  --cat   Print Markdown contents instead of the file path
EOF
}

print_human_help() {
  print_core_help
  cat <<EOF

Inputs:
  - LaTeX-style citation (e.g. \\citet{vesper:2012_jumping})
  - BibTeX key with colons (e.g. vesper:2012_jumping)
  - Normalized key without colons (e.g. vesper2012_jumping)

Environment:
  - PAPERS_DIR (default: ${PAPERS_DIR})
  - INDEX_FILE (default: ${INDEX_FILE})
  - missing-fulltext.txt is appended in the current working directory when lookups fail

Resolution strategy:
  1) Search PAPERS_DIR for files ending with <normalized-key>.md
  2) Fall back to bibtex-index.jsonl (matches .key and colon-stripped variants)

Dependencies:
  - fd, jq, sed, awk

Human shortcuts:
  --vs       Print the path then open in VS Code
  --vsi      Print the path then open in VS Code Insiders
  --reveal   Reveal the path in Finder (macOS) or xdg-open the directory (Linux)

Workflow tips:
  - Combine with draft2keys to resolve citations from drafts.
  - Pipe through rg once you have the Markdown path for in-document search.
EOF
}

human_requested=false
help_requested=false
for arg in "$@"; do
  case "$arg" in
    --human) human_requested=true ;;
    -h|--help) help_requested=true ;;
  esac
done

if $human_requested; then
  for arg in "$@"; do
    case "$arg" in
      --human|-h|--help) ;;
      *)
        echo "cite2md: --human cannot be combined with $arg" >&2
        exit 2
        ;;
    esac
  done
  print_human_help
  exit 0
fi

if $help_requested; then
  print_core_help
  exit 0
fi

if [ $# -lt 1 ]; then
  # no args: may be stdin mode or help
  if [ -t 0 ]; then
    print_core_help >&2
    exit 2
  fi
fi

# Parse flags
MODE="path" # default: print file path
HUMAN_ACTION=""
HUMAN_ACTION_FLAG=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --cat)
      if [[ -n "$HUMAN_ACTION" ]]; then
        echo "cite2md: --cat cannot be combined with $HUMAN_ACTION_FLAG" >&2
        exit 2
      fi
      MODE="cat"; shift ;;
    --vs)
      if [[ "$MODE" == "cat" ]]; then
        echo "cite2md: --vs cannot be combined with --cat" >&2
        exit 2
      fi
      if [[ -n "$HUMAN_ACTION" && "$HUMAN_ACTION" != "code" ]]; then
        echo "cite2md: --vs cannot be combined with $HUMAN_ACTION_FLAG" >&2
        exit 2
      fi
      HUMAN_ACTION="code"
      HUMAN_ACTION_FLAG="--vs"
      shift ;;
    --vsi)
      if [[ "$MODE" == "cat" ]]; then
        echo "cite2md: --vsi cannot be combined with --cat" >&2
        exit 2
      fi
      if [[ -n "$HUMAN_ACTION" && "$HUMAN_ACTION" != "code_insiders" ]]; then
        echo "cite2md: --vsi cannot be combined with $HUMAN_ACTION_FLAG" >&2
        exit 2
      fi
      HUMAN_ACTION="code_insiders"
      HUMAN_ACTION_FLAG="--vsi"
      shift ;;
    -r|--reveal)
      if [[ "$MODE" == "cat" ]]; then
        echo "cite2md: --reveal cannot be combined with --cat" >&2
        exit 2
      fi
      if [[ -n "$HUMAN_ACTION" && "$HUMAN_ACTION" != "reveal" ]]; then
        echo "cite2md: --reveal cannot be combined with $HUMAN_ACTION_FLAG" >&2
        exit 2
      fi
      HUMAN_ACTION="reveal"
      HUMAN_ACTION_FLAG="--reveal"
      shift ;;
    --)
      shift; break ;;
    -*)
      echo "Unknown flag: $1" >&2; exit 2 ;;
    *)
      break ;;
  esac
done

# Collect inputs: remaining args or stdin if none
declare -a INPUTS
if [[ $# -gt 0 ]]; then
  while [[ $# -gt 0 ]]; do
    INPUTS+=("$1"); shift
  done
else
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    INPUTS+=("$line")
  done
fi

if [[ ${#INPUTS[@]} -eq 0 ]]; then
  echo "cite2md: no input keys provided" >&2
  exit 2
fi

resolved_any=false
missing_log_file="missing-fulltext.txt"
action_failed=false

resolve_one() {
  local input="$1"; local bibkey normkey file rel
  # Extract bibkey if LaTeX citation; otherwise use input as key
  if [[ "$input" =~ \{[^}]+\} ]]; then
    bibkey=$(printf '%s\n' "$input" | sed -n 's/.*{\([^}]*\)}.*/\1/p')
  else
    bibkey="$input"
  fi
  if [ -z "$bibkey" ]; then
    echo "cite2md: could not parse a key from input: $input" >&2
    return 1
  fi
  normkey=$(printf '%s' "$bibkey" | tr -d ':')
  file=$(fd -a -t f --regex "${normkey}\\.md$" "$PAPERS_DIR" | head -n1 || true)
  if [ -z "$file" ] && [ -f "$INDEX_FILE" ]; then
    rel=$(jq -r --arg k "$bibkey" 'select(.key==$k) | .path // .filename' "$INDEX_FILE" 2>/dev/null || true)
    if [ -z "${rel:-}" ] || [ "$rel" = "null" ]; then
      rel=$(jq -r --arg nk "$normkey" 'select((.key|gsub(":";""))==$nk) | .path // .filename' "$INDEX_FILE" 2>/dev/null || true)
    fi
    if [ -n "${rel:-}" ] && [ "$rel" != "null" ]; then
      file="$PAPERS_DIR/$rel"
    fi
  fi
  if [ -z "$file" ] || [ ! -f "$file" ]; then
    echo "MISSING cite2md: $bibkey (normalized: $normkey) in $PAPERS_DIR" >&2
    printf '%s\n' "$bibkey" >> "$missing_log_file"
    return 1
  fi
  case "$MODE" in
    path)
      case "$HUMAN_ACTION" in
        "")
          printf '%s\n' "$file"
          ;;
        code)
          printf '%s\n' "$file"
          if ! command -v code >/dev/null 2>&1; then
            echo "cite2md: VS Code command 'code' not found on PATH" >&2
            action_failed=true
          elif ! code "$file"; then
            echo "cite2md: failed to open $file in VS Code" >&2
            action_failed=true
          fi
          ;;
        code_insiders)
          printf '%s\n' "$file"
          if ! command -v code-insiders >/dev/null 2>&1; then
            echo "cite2md: VS Code Insiders command 'code-insiders' not found on PATH" >&2
            action_failed=true
          elif ! code-insiders "$file"; then
            echo "cite2md: failed to open $file in VS Code Insiders" >&2
            action_failed=true
          fi
          ;;
        reveal)
          if ! command -v open >/dev/null 2>&1; then
            echo "cite2md: Finder reveal requires the 'open' command" >&2
            printf '%s\n' "$file"
            action_failed=true
          elif ! open -R "$file"; then
            echo "cite2md: failed to reveal $file via open -R" >&2
            printf '%s\n' "$file"
            action_failed=true
          fi
          ;;
      esac
      ;;
    cat)
      cat "$file" ;;
  esac
  return 0
}

rc_overall=1
for token in "${INPUTS[@]}"; do
  if resolve_one "$token"; then
    resolved_any=true
  fi
done

if $resolved_any; then rc_overall=0; fi
if $action_failed; then rc_overall=1; fi
exit $rc_overall
