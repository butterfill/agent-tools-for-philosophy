#!/usr/bin/env bash
set -euo pipefail

# fd-sources — fd scoped to Markdown sources in PAPERS_DIR (search by filename)

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

print_help() {
  cat <<'EOF'
fd-sources — filename search scoped to fulltext sources

Usage:
  fd-sources [fd-flags...] [--] [pattern] [paths...]

Notes:
  - Use the cat-sources tool to stream the Markdown fulltext of a filename discovered with fd-sources (via a pipe).

Examples:
  fd-sources vesper2012_jumping
  fd-sources -i 'vesper.*jump'
  fd-sources -i 'butterfill.*2019'
  fd-sources vesper2012_jumping | cat-sources
EOF
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  print_help
  exit 0
fi

command -v fd >/dev/null 2>&1 || { echo "fd-sources: fd not found on PATH" >&2; exit 2; }

if [[ ! -d "$PAPERS_DIR" ]]; then
  echo "fd-sources: PAPERS_DIR not found: $PAPERS_DIR" >&2
  exit 2
fi

declare -a ARGS

for arg in "$@"; do
  # Disallow absolute paths anywhere
  if [[ "$arg" == /* ]]; then
    echo "fd-sources: absolute paths not allowed: $arg" >&2
    exit 2
  fi
  # Disallow parent-directory tokens anywhere
  if [[ "$arg" == ../* || "$arg" == */../* || "$arg" == */.. || "$arg" == ./../* || "$arg" == ".." ]]; then
    echo "fd-sources: parent-directory paths not allowed: $arg" >&2
    exit 2
  fi

  case "$arg" in
    -e|--extension|--extension=*)
      echo "fd-sources: file type overrides are not supported; use fd directly for non-Markdown" >&2
      exit 2 ;;
  esac

  ARGS+=("$arg")
done

cd "$PAPERS_DIR"

declare -a CMD
CMD=(fd)

CMD+=("--extension" "md" "--extension" "mdx")

exec "${CMD[@]}" "${ARGS[@]}"
