#!/usr/bin/env bash
set -euo pipefail

# fd-sources — fd scoped to Markdown sources in PAPERS_DIR (search by filename)

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

print_help() {
  cat <<'EOF'
fd-sources — filename search scoped to fulltext sources

Usage:
  fd-sources [fd-flags...] [--] [pattern] [paths...]
  fd-sources [fd-flags...] --cat [pattern]

Notes:
  - Use the cat-sources tool to stream the Markdown fulltext of a filename discovered with fd-sources.

Examples:
  fd-sources vesper2012_jumping
  fd-sources -i 'vesper.*jump'
  fd-sources -e md -e mdx butterfill
  fd-sources vesper2012_jumping --cat
EOF
}

if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
  print_help
  exit 0
fi

command -v fd >/dev/null 2>&1 || { echo "fd-sources: fd not found on PATH" >&2; exit 2; }

if [[ ! -d "$PAPERS_DIR" ]]; then
  echo "fd-sources: PAPERS_DIR not found: $PAPERS_DIR" >&2
  exit 2
fi

do_cat=false

declare -a ARGS

for arg in "$@"; do
  # Disallow absolute paths anywhere
  if [[ "$arg" == /* ]]; then
    echo "fd-sources: absolute paths not allowed: $arg" >&2
    exit 2
  fi
  # Disallow parent-directory tokens anywhere
  if [[ "$arg" == ../* || "$arg" == */../* || "$arg" == */.. || "$arg" == ./../* || "$arg" == ".." ]]; then
    echo "fd-sources: parent-directory paths not allowed: $arg" >&2
    exit 2
  fi

  case "$arg" in
    --cat) do_cat=true; continue ;;
    -e|--extension|--extension=*)
      echo "fd-sources: file type overrides are not supported; use fd directly for non-Markdown" >&2
      exit 2 ;;
  esac

  ARGS+=("$arg")
done

cd "$PAPERS_DIR"

declare -a CMD
CMD=(fd)

CMD+=("--extension" "md" "--extension" "mdx")

if $do_cat; then
  # Stream results into cat-sources
  set -o pipefail
  cs_bin=$(command -v cat-sources 2>/dev/null || true)
  if [[ -z "${cs_bin:-}" && -x "$SCRIPT_DIR/cat-sources" ]]; then
    cs_bin="$SCRIPT_DIR/cat-sources"
  fi
  if [[ -z "${cs_bin:-}" ]]; then
    echo "fd-sources: cat-sources not found on PATH or alongside script" >&2
    exit 2
  fi
  "${CMD[@]}" "${ARGS[@]}" | "$cs_bin"
else
  exec "${CMD[@]}" "${ARGS[@]}"
fi
