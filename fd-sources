#!/usr/bin/env bash
set -euo pipefail

# fd-sources — fd scoped to Markdown sources in PAPERS_DIR (search by filename)

PAPERS_DIR=${PAPERS_DIR:-"$HOME/papers"}
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

print_core_help() {
  cat <<'EOF'
fd-sources — filename search scoped to fulltext sources

Usage:
  fd-sources [fd-flags...] [--] [pattern] [paths...]

Behavior:
  - Restricts search to Markdown files under PAPERS_DIR
  - Exits 2 if absolute or parent-directory paths are provided
EOF
}

print_human_help() {
  print_core_help
  cat <<EOF

Environment:
  - PAPERS_DIR (default: ${PAPERS_DIR})

Dependencies:
  - fd

Workflow tips:
  - Pipe into cat-sources to stream content once you have a relative path.
  - Combine with rg-sources for content search, then fd-sources for filename refinement.

Notes:
  - File type overrides (-e/--extension) are blocked to prevent leaving Markdown scope.
  - To search other formats, run fd directly with your own globbing.
EOF
}

human_requested=false
help_requested=false
for arg in "$@"; do
  case "$arg" in
    --human) human_requested=true ;;
    -h|--help) help_requested=true ;;
  esac
done

if $human_requested; then
  for arg in "$@"; do
    case "$arg" in
      --human|-h|--help) ;;
      *)
        echo "fd-sources: --human cannot be combined with $arg" >&2
        exit 2
        ;;
    esac
  done
  print_human_help
  exit 0
fi

if $help_requested; then
  print_core_help
  exit 0
fi

command -v fd >/dev/null 2>&1 || { echo "fd-sources: fd not found on PATH" >&2; exit 2; }

if [[ ! -d "$PAPERS_DIR" ]]; then
  echo "fd-sources: PAPERS_DIR not found: $PAPERS_DIR" >&2
  exit 2
fi

declare -a ARGS

for arg in "$@"; do
  # Disallow absolute paths anywhere
  if [[ "$arg" == /* ]]; then
    echo "fd-sources: absolute paths not allowed: $arg" >&2
    exit 2
  fi
  # Disallow parent-directory tokens anywhere
  if [[ "$arg" == ../* || "$arg" == */../* || "$arg" == */.. || "$arg" == ./../* || "$arg" == ".." ]]; then
    echo "fd-sources: parent-directory paths not allowed: $arg" >&2
    exit 2
  fi

  case "$arg" in
    -e|--extension|--extension=*)
      echo "fd-sources: file type overrides are not supported; use fd directly for non-Markdown" >&2
      exit 2 ;;
  esac

  ARGS+=("$arg")
done

cd "$PAPERS_DIR"

declare -a CMD
CMD=(fd)

CMD+=("--extension" "md" "--extension" "mdx")

exec "${CMD[@]}" "${ARGS[@]}"
